# 比特币与区块链基本概念入门

## 比特币的历史
2008年，一位化名为中本聪的人，在一篇名为《比特币：一个点对点的电子现金系统》的论文中首先提出了比特币（[中文版白皮书](http://www.8btc.com/wiki/bitcoin-a-peer-to-peer-electronic-cash-system)）。简单说，比特币结合以前的多个数字货币发明，如B-money和HashCash，创建了一个完全去中心化的电子现金系统，不依赖于通货保障或是结算交易验证保障的中央权威。关键的创新是利用分布式计算系统（称为“工作量证明”算法）每隔10分钟进行一次的全网“选拔”，能够使去中心化的网络同步交易记录。这个能优雅的解决双重支付问题，即一个单一的货币单位可以使用两次。

为什么要去中心化，比特币创世区块里的信息已经给出了答案：The Times 03/Jan/2009 Chancellor on brink of second bailout for banks. 这条信息是当天泰晤士报头版的标题。

### 什么是双花问题
简单说就是小明手里有5块钱，但是利用各种技术手段买了2份5块钱的东西。比如时间差，比如自己画了一张假钞。假钞容易理解，时间差需要花点时间解释一下。比如在远古时代网上购物，发送汇款证明后商家发货。但是汇款有一个很长的时延，那么小明可以在等到商家发货后取消取款，然后再去另一个商户购物。运气好的话有可能四花五花都能完成。这里很重要的一点就是利用时间差来作恶，在分布式系统里这个问题尤其严重，下一节会专门讨论。淘宝当年为了解决这个问题成立了支付宝。但是中心化的中介机构可能带来另一个问题，就是卷钱跑路。

### 分布式系统处理双花问题的难点
对于分布式系统解决双花问题，由于消息传递存在时间差，并且没有中心化的中介机构进行协调，本质就是如何有效的解决一个[拜占庭将军问题](https://zh.wikipedia.org/zh-sg/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98)。一般业内常用两阶段/三阶段提交协议，或者Paxos算法来解决这个问题，但是这些方案依然需要一些中心化的基础设施来参与协调解决。比特币系统把这个问题做了简化，通过工作量证明机制降低信息发送频率，大大减少了需要进行同步的信息数量。目前的每10分钟完成一次打包，可以等价看成将军派出一名信使，这样大家就有充足的时间达成共识，如果在规定时间内依然无法达成共识而有新的消息就来时，老的信息就宣布作废。

## 区块链核心技术

### 区块与交易
本质上就是账本。利用区块记录曾经发生的交易。比特币的每个区块本质上是一系列交易的打包，而挖矿就是争夺打包的权利。注意，这里有个非常重要的概念，对于区块链上的用户来说，并没有类似于支付宝或微信钱包的余额概念！你到底有多少可用余额是必须通过历史账单计算产生。

对于比特币，每笔交易包含以下要素：上笔交易Hash，交易支付对象和交易金额。与传统概念的余额不同，比如以下交易场景，你用户A有1个比特币，需要向商家S购买0.8比特币的商品，并没有一个余额字段给你操作，而是根据你交易的历史账单决定你有多少可用余额。现实场景很可能是在之前的2个交易T1和T2中分别获取了0.3和0.7个比特币。那么我们的实际交易必须有三条记录构成，因为还需要处理找零：
> - X1: T1 -> S, 0.3（简化表示，实际包含更多信息。）
> - X2: T2 -> S, 0.5
> - X3: T2 -> A, 0.2

X1把交易T1收到的0.3个币转给S，X2转0.5个币，总共转0.8个币给S，X3非常重要，因为完成了找零，下次交易时从这笔交易可以支出最多0.2个比特币。

### 链
链的作用就是把区块串联起来，因为比特币每个区块大小1M，能够打包的交易数量有限，所以必须通过链把这些区块串联起来，并却通过数学工具使得安全性可以验证。从比特币源代码我们可以看到每一块的数据区头部结构包含以下信息：
> - 版本号
> - 前一个区块的Hash，当前区块的Hash一定更小。
> - Merkle树的根，即当前区块中所有交易Merkle树的根节点的Hash值。
> - 记录当前区块生成时间的Unix格式时间戳
> - 当前区块的Hash值，即挖矿计算对象。
> - 当前区块工作量证明的随机数

同时由于在分布式系统上存在延时问题，链的长度可能不一样，在比特币系统里选择最长的链作为主链进行记账。简单来说，最长的链就是最多算力支持的链。简单说，攻击者必须控制51%的算力才能把自己虚构的数据打包记录进最长链，否则不如老老实实挖矿来得收益高。当然，实际情况可能不需要51%算计也能发起攻击，或者直接硬分叉各玩各的。详细信息可以参考一下比特大陆与Core的恩怨情仇。

### 非对称加密机制
因为比特币没有中心化的账号系统，所以在每一笔交易里面支出和接收地址都必须表明，但这就带来了安全性的问题。如果不采取加密措施的话，别人很容易伪造交易使用你的账号任意消费。所以比特币采用了非堆成加密机制，使用公钥生成账号地址，同时在交易中使用私钥签名，如果公钥无法验证私钥签名的话，就意味着这笔交易无效。虽然公钥在网上完全公开，但是因为没有私钥无法构造签名，所以伪造交易记录变得几乎不可能。

### Merkel树
先澄清一个观点，Merkel树和区块链的链没啥关系，主要是区块内部用于验证交易的完整性以及验证某个交易是否合法。

Merkel树的构建过程是自底向上构建的。在如下的例子中，我们从A、B、C、D四个构成Merkle树树叶的交易开始，如下图所示。起始时所有的交易都还未存储在Merkle树中，而是先将数据哈希化，然后将哈希值存储至相应的叶子节点。这些叶子节点分别是HA、HB、HC和HD：
> - H-A = SHA256(SHA256(交易A))
> - H-AB =SHA256(SHA256(H-A + H-B))

继续类似的操作直到只剩下顶部的一个节点，即Merkle根。产生的32字节哈希值存储在区块头，同时归纳了四个交易的所有数据。因为Merkle树是二叉树，所以它需要偶数个叶子节点。如果仅有奇数个交易需要归纳，那最后的交易就会被复制一份以构成偶数个叶子节点，这种偶数个叶子节点的树也被称为平衡树。

![Merkel Tree](http://zhibimo.com/read/wang-miao/mastering-bitcoin/Images/Fig702.png)

### 挖矿共识机制
PoW = Prove of Work，工作量证明机制，也是目前比特币采用的共识机制。这个机制，简单的说就是谁的矿机多，谁就有更大的机会获得记账的权利，而所谓的挖矿就是获得记账权利后进行记账的报酬。虽然工作量证明机制矿机面前人人平等，但是大矿场因为算力集中，为了自己的利益作恶也是常会发生的。比如最近的某次比特币价格暴跌，直接原因就是大矿场为了顶BCH，针对比特币进行算力攻击，造成大量交易拥堵，无法进行结算。关于PoW，很多同学还有个疑问，如果2100万个比特币都挖完了，矿工怎么赚钱？虽然获得记账权利之后没有奖励，但是交易打包是要收费的，所以收消费依然可以获得收入。就像黄金一样，就算黄金挖完了，只要有交易，就是抽头。

PoS = Prove of Stake，股权证明机制，简单说谁的股份越多谁的发言权越大。这里引入了一个币龄的概念。如果A有50个币，B有80个币，是不是B更容易获得记账权利呢？答案是要看情况而定。如果A已经持有了30天，而B只有15天，那么A的币龄就是1500，而B只有1200，所以A获得记账权的概率更高，如果A没有获得而B获得，那么B在获得记账权的同时部分币龄被清空，A则继续累积，下次竞争时A会拥有更高的概率。股权证明机制的优点在于通过鼓励大股东持币维护系统良好运行，不像PoW机制算力和币是分离的，但是缺点在于PoS机制下所有币是一次性发放的，创始人和早期私募用户占有很大的仓位，有操控价格的动机和能力，不像PoW机制下创始人也得慢慢挖矿。所以从目前币圈看基于PoS的币都不成功。以太坊的选择是PoW + PoS，在未来发行到一定数量后，再逐步转PoS。

DPoS = 委托权益证明，长话短说，参考美国的选举人制度。

### 观念误区
比特币是匿名的，不可监管的。但是实际上，比特币的监管成本是非常低的，因为账本是公开的，代码是开源的，只要监管机构愿意，所有交易历史记录一目了然，时间，交易双方，金额。哪怕用混淆交易的手法，只要监管部门愿意，打击是分分钟的事，比如SilkRoad被FBI查抄。目前之所以有这个误区，是因为去中心化的数字货币与法币的根本矛盾，使得监管部门处于一个两难的位置。这个话题足以写N篇大作文了。

## Token与链的关系
链是基础设施，而币只是衍生产品，本质是一种凭证，在不同共识机制下，代表你为维护这个链运行付出的成本（维护一个分布式系统一定是要付出成本的！！！比如挖矿的电力消耗），或者你在这个链里的投票权，类似与BTS（比特股）的机制。大家在投身区块链事业之前，建议好好读一读这篇访谈：[通证(token)是下一代互联网数字经济的关键——元道区块链对话之一](http://blog.csdn.net/myan/article/details/78712506)

![架构](http://bitcoin-on-nodejs.ebookchain.org/styles/images/third/blockchain_overview.png)
